#!/usr/bin/make -f

export DH_VERBOSE = 1
NX_VERSION := 21.0.4

%:
	dh $@

override_dh_auto_build:
	# Verify build dependencies
	@which node > /dev/null || (echo "ERROR: node not found. Please install nodejs as build dependency." && exit 1)
	@which curl > /dev/null || (echo "ERROR: curl not found. Please install curl as build dependency." && exit 1)
	
	# Download and extract nx from npm registry
	curl -o nx-$(NX_VERSION).tgz https://registry.npmjs.org/nx/-/nx-$(NX_VERSION).tgz
	mkdir -p debian/tmp/usr/lib/nx/node_modules/nx
	tar -xzf nx-$(NX_VERSION).tgz -C debian/tmp/usr/lib/nx/node_modules/nx --strip-components=1
	
	# Note: Skipping npm install as nx package should be self-contained
	
	# Create binary wrapper with Node.js version check
	mkdir -p debian/tmp/usr/bin
	echo '#!/bin/bash' > debian/tmp/usr/bin/nx
	echo '# NX wrapper script with Node.js version check' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Check Node.js version' >> debian/tmp/usr/bin/nx
	echo 'NODE_VERSION=$$(node -v 2>/dev/null | sed "s/v//")' >> debian/tmp/usr/bin/nx
	echo 'REQUIRED_VERSION="20.0.0"' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Version comparison function' >> debian/tmp/usr/bin/nx
	echo 'version_lt() {' >> debian/tmp/usr/bin/nx
	echo '    # Returns 0 (true) if $$1 < $$2' >> debian/tmp/usr/bin/nx
	echo '    test "$$(printf "%s\\n" "$$1" "$$2" | sort -V | head -n 1)" = "$$1"' >> debian/tmp/usr/bin/nx
	echo '}' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Check if Node.js version is sufficient' >> debian/tmp/usr/bin/nx
	echo 'if [ -n "$$NODE_VERSION" ] && version_lt "$$NODE_VERSION" "$$REQUIRED_VERSION"; then' >> debian/tmp/usr/bin/nx
	echo '    echo "⚠️  Warning: NX requires Node.js 20 or higher. You have Node.js $$NODE_VERSION." >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "To update Node.js on Ubuntu/Debian, we recommend using NodeSource:" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  sudo apt-get install -y nodejs" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "Alternative methods:" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  - Using nvm: https://github.com/nvm-sh/nvm" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  - Using fnm: https://github.com/Schniz/fnm" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  - Using snap: sudo snap install node --classic --channel=20" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "" >&2' >> debian/tmp/usr/bin/nx
	echo 'fi' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Run nx with proper NODE_PATH' >> debian/tmp/usr/bin/nx
	echo 'NODE_PATH="/usr/lib/nx/node_modules" exec node /usr/lib/nx/node_modules/nx/bin/nx.js "$$@"' >> debian/tmp/usr/bin/nx
	chmod +x debian/tmp/usr/bin/nx

override_dh_auto_clean:
	rm -f nx-*.tgz
	dh_auto_clean

override_dh_auto_test:
	# Skip tests

override_dh_auto_install:
	# Recreate files that dh_prep may have removed
	mkdir -p debian/tmp/usr/lib/nx/node_modules/nx
	mkdir -p debian/tmp/usr/bin
	
	# Download and extract nx again if needed
	test -f nx-$(NX_VERSION).tgz || curl -o nx-$(NX_VERSION).tgz https://registry.npmjs.org/nx/-/nx-$(NX_VERSION).tgz
	tar -xzf nx-$(NX_VERSION).tgz -C debian/tmp/usr/lib/nx/node_modules/nx --strip-components=1
	
	# Install nx dependencies
	cd debian/tmp/usr/lib/nx/node_modules/nx && npm install --production --omit=dev
	
	# Recreate binary wrapper with Node.js version check
	echo '#!/bin/bash' > debian/tmp/usr/bin/nx
	echo '# NX wrapper script with Node.js version check' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Check Node.js version' >> debian/tmp/usr/bin/nx
	echo 'NODE_VERSION=$$(node -v 2>/dev/null | sed "s/v//")' >> debian/tmp/usr/bin/nx
	echo 'REQUIRED_VERSION="20.0.0"' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Version comparison function' >> debian/tmp/usr/bin/nx
	echo 'version_lt() {' >> debian/tmp/usr/bin/nx
	echo '    # Returns 0 (true) if $$1 < $$2' >> debian/tmp/usr/bin/nx
	echo '    test "$$(printf "%s\\n" "$$1" "$$2" | sort -V | head -n 1)" = "$$1"' >> debian/tmp/usr/bin/nx
	echo '}' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Check if Node.js version is sufficient' >> debian/tmp/usr/bin/nx
	echo 'if [ -n "$$NODE_VERSION" ] && version_lt "$$NODE_VERSION" "$$REQUIRED_VERSION"; then' >> debian/tmp/usr/bin/nx
	echo '    echo "⚠️  Warning: NX requires Node.js 20 or higher. You have Node.js $$NODE_VERSION." >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "To update Node.js on Ubuntu/Debian, we recommend using NodeSource:" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  sudo apt-get install -y nodejs" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "Alternative methods:" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  - Using nvm: https://github.com/nvm-sh/nvm" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  - Using fnm: https://github.com/Schniz/fnm" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "  - Using snap: sudo snap install node --classic --channel=20" >&2' >> debian/tmp/usr/bin/nx
	echo '    echo "" >&2' >> debian/tmp/usr/bin/nx
	echo 'fi' >> debian/tmp/usr/bin/nx
	echo '' >> debian/tmp/usr/bin/nx
	echo '# Run nx with proper NODE_PATH' >> debian/tmp/usr/bin/nx
	echo 'NODE_PATH="/usr/lib/nx/node_modules" exec node /usr/lib/nx/node_modules/nx/bin/nx.js "$$@"' >> debian/tmp/usr/bin/nx
	chmod +x debian/tmp/usr/bin/nx
