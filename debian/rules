#!/usr/bin/make -f

export DH_VERBOSE = 1
NX_VERSION := $(shell echo $(DEB_VERSION_UPSTREAM))

%:
	dh $@

override_dh_auto_build:
	# Download and extract nx
	npm pack nx@$(NX_VERSION)
	mkdir -p debian/tmp/usr/lib/nx/node_modules/nx
	tar -xzf nx-$(NX_VERSION).tgz -C debian/tmp/usr/lib/nx/node_modules/nx --strip-components=1
	
	# Install dependencies
	cd debian/tmp/usr/lib/nx/node_modules/nx && npm install --production
	
	# Create binary wrapper with Node.js version check
	mkdir -p debian/tmp/usr/bin
	cat > debian/tmp/usr/bin/nx << 'EOF'
#!/bin/bash

# Check Node.js version and warn if < 20
NODE_VERSION=$$(node -v 2>/dev/null | grep -oE 'v[0-9]+' | cut -c2-)

if [ -n "$$NODE_VERSION" ] && [ "$$NODE_VERSION" -lt 20 ]; then
    cat >&2 << 'WARNING'
╔══════════════════════════════════════════════════════════════════════╗
║                         ⚠️  NODE.JS WARNING ⚠️                       ║
╠══════════════════════════════════════════════════════════════════════╣
║ You are using an older version of Node.js that may not be fully      ║
║ compatible with nx. Node.js >= 20 is recommended for optimal         ║
║ compatibility.                                                       ║
║                                                                      ║
║ Your current version may work but could encounter issues.            ║
║                                                                      ║
║ To upgrade Node.js:                                                  ║
║ • Visit: https://nodejs.org/en/download/                             ║
║ • Or use NodeSource: https://github.com/nodesource/distributions     ║
║                                                                      ║
║ For Ubuntu/Debian:                                                   ║
║   curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -  ║
║   sudo apt-get install -y nodejs                                     ║
╚══════════════════════════════════════════════════════════════════════╝

WARNING
fi

# Execute nx with proper NODE_PATH
NODE_PATH="/usr/lib/nx/node_modules" exec node /usr/lib/nx/node_modules/nx/bin/nx.js "$$@"
EOF
	chmod +x debian/tmp/usr/bin/nx

override_dh_auto_clean:
	rm -f nx-*.tgz
	dh_auto_clean

override_dh_auto_test:
	# Skip tests

override_dh_auto_install:
	# Files are already in debian/tmp, dh_install will handle them

